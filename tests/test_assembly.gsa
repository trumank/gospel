global test_global = 5;

function InvokerType invoke: Closure -> TypeReference max_slots 0 {
    LoadArgumentValue invoke;
    Call 0;
    SetReturnValue;
};

function ClosureCallFunction first: Integer second: Integer -> Integer max_slots 0 {
    LoadArgumentValue first;
    LoadArgumentValue second;
    Add;
    SetReturnValue;
};

function ClosureTest -> Integer max_slots 1 {
    LoadFunctionClosure function ClosureCallFunction;
    IntConstant 5;
    BindClosure 1;
A:  Slot Closure;
    StoreSlot 0;
    IntConstant 7;
    LoadSlot 0;
    Call 1;
    SetReturnValue;
};

function ArrayTest -> Array max_slots 0 {
    ArrayAllocate;
    IntConstant 3;
    ArrayReserve;
    IntConstant 15;
    ArrayPushItem;
    IntConstant 0;
    IntConstant 10;
    ArrayInsertItem;
    Dup;
    Dup;
    ArrayGetLength;
    IntConstant 1;
    Sub;
    ArrayGetItem;
    IntConstant 1;
    Add;
    ArrayPushItem;
    SetReturnValue;
};

function AbortTest -> Integer max_slots 0 {
    RaiseException "abort test";
};

structure TestStruct {
    named_field: Integer;
    test_field: Integer;
    Integer;
};

structure LocalStruct {
    Integer;
};

function StructTest -> Struct max_slots 1 {
    StructAllocate TestStruct;
    IntConstant 15;
    StructSetLocalField TestStruct 0;
    IntConstant 10;
    StructSetNamedField TestStruct "test_field";
    Dup;
    Dup;
    StructGetLocalField TestStruct 1;
    StoreSlot 0;
    StructGetNamedField TestStruct "named_field";
    LoadSlot 0;
    Mul;
    StructSetLocalField TestStruct 2;
    SetReturnValue;
};

function LocalStructTest -> Struct max_slots 0 {
    StructAllocate structure LocalStruct;
    IntConstant 20;
    StructSetLocalField structure LocalStruct 0;
    SetReturnValue;
};

function ExceptionHandlerTest value: Integer -> Integer max_slots 0 {
    IntConstant 5;
    PushExceptionHandler A;
    Pop;
    IntConstant 2;
    LoadArgumentValue value;
    IntConstant 1;
    Sub;
    Ez;
    Branchz B;
    RaiseException "Value of 1 is bad";
B:  PopExceptionHandler;
    Branch C;
A:  IntConstant 1;
    Sub;
C:  SetReturnValue;
};
